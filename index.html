<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meta-G Dashboard</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container { max-width: 1000px; margin: auto; padding: 20px; }
    h1 { text-align: center; font-size: 2.5rem; margin-bottom: 20px; }
    .task-section {
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .task-section.work { background-color: #e1f0ff; border-left: 10px solid #007bff; }
    .task-section.personal { background-color: #e8fce8; border-left: 10px solid #28a745; }
    ul { list-style: none; padding-left: 0; }
    ul li {
      font-size: 1.2rem;
      margin: 8px 0;
      padding: 8px 12px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    ul li.completed { text-decoration: line-through; color: #aaa; }
    .add-task { display: flex; gap: 10px; margin-top: 10px; }
    .add-task input {
      flex: 1; padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .add-task button {
      padding: 8px 12px;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .calendar {
      padding: 20px;
      border-radius: 20px;
      background-color: #fff3cd;
      border-left: 10px solid #ffc107;
      margin-bottom: 40px;
    }
    .calendar iframe { width: 100%; height: 600px; border: none; }
    .chatgpt {
      padding: 20px;
      border-radius: 20px;
      background-color: #f0e7ff;
      border-left: 10px solid #9f4dff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .gpt-input {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .gpt-input textarea {
      width: 100%;
      height: 80px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      resize: none;
    }
    .gpt-input button {
      padding: 10px;
      border-radius: 8px;
      background-color: #9f4dff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .gpt-response {
      margin-top: 10px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    .status-indicator {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-bottom: 10px;
    }
    .database-connected { color: #28a745; }
    .localStorage-fallback { color: #ffc107; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Meta-G Task Dashboard</h1>
    <div class="status-indicator" id="connection-status">üîÑ Connecting to database...</div>

    <section class="task-section work">
      <h2>üíº Work Tasks</h2>
      <ul id="work-list"></ul>
      <div class="add-task">
        <input type="text" id="new-work-task" placeholder="Add work task...">
        <button onclick="addTask('work')">Add</button>
      </div>
    </section>

    <section class="task-section personal">
      <h2>üè† Personal Tasks</h2>
      <ul id="personal-list"></ul>
      <div class="add-task">
        <input type="text" id="new-personal-task" placeholder="Add personal task...">
        <button onclick="addTask('personal')">Add</button>
      </div>
    </section>

    <section class="calendar">
      <h2>üóìÔ∏è Shared Calendar View</h2>
      <iframe
        src="https://calendar.google.com/calendar/embed?src=davidvanosdol88%40gmail.com&ctz=America%2FNew_York"
        frameborder="0"
        scrolling="no">
      </iframe>
    </section>

    <section class="chatgpt">
      <h2>ü§ñ Chat Assistant</h2>
      <div class="gpt-input">
        <textarea id="gpt-prompt" placeholder="Ask ChatGPT something..."></textarea>
        <button onclick="submitPrompt()">Send</button>
        <div class="gpt-response" id="gpt-response"></div>
      </div>
    </section>
  </div>

  <script>
    // Updated Dashboard frontend JavaScript to use database API instead of localStorage
    const API_BASE_URL = 'https://dashboard-api-6n0s.onrender.com/api';
    let usingDatabase = false;

    // Database functions
    async function loadTasks() {
      try {
        const response = await fetch(`${API_BASE_URL}/tasks/default_user`);
        if (!response.ok) throw new Error('Failed to fetch tasks');
        
        const tasks = await response.json();
        usingDatabase = true;
        updateConnectionStatus('database');
        
        const workTasks = tasks.filter(task => task.type === 'work');
        const personalTasks = tasks.filter(task => task.type === 'personal');
        
        renderTasksFromDatabase('work', workTasks);
        renderTasksFromDatabase('personal', personalTasks);
        
        console.log('‚úÖ Tasks loaded from database:', tasks.length);
      } catch (error) {
        console.error('‚ùå Error loading tasks:', error);
        usingDatabase = false;
        updateConnectionStatus('localStorage');
        loadTasksFromLocalStorage();
      }
    }

    async function saveTask(text, type) {
      if (usingDatabase) {
        try {
          const response = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: text,
              type: type,
              userId: 'default_user'
            })
          });
          
          if (!response.ok) throw new Error('Failed to save task');
          
          const newTask = await response.json();
          console.log('‚úÖ Task saved to database:', newTask);
          await loadTasks();
          return;
          
        } catch (error) {
          console.error('‚ùå Error saving task:', error);
          usingDatabase = false;
          updateConnectionStatus('localStorage');
        }
      }
      
      // Fallback to localStorage
      saveTaskToLocalStorage(text, type);
    }

    async function toggleTaskCompletion(taskId, completed) {
      if (usingDatabase) {
        try {
          const response = await fetch(`${API_BASE_URL}/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ completed: completed })
          });
          
          if (!response.ok) throw new Error('Failed to update task');
          
          const updatedTask = await response.json();
          console.log('‚úÖ Task updated in database:', updatedTask);
          await loadTasks();
          return;
          
        } catch (error) {
          console.error('‚ùå Error updating task:', error);
          usingDatabase = false;
          updateConnectionStatus('localStorage');
        }
      }
      
      // Fallback to localStorage
      toggleTaskInLocalStorage(taskId, completed);
    }

    function renderTasksFromDatabase(type, tasks) {
      const list = document.getElementById(`${type}-list`);
      list.innerHTML = '';
      
      tasks.forEach(task => {
        const li = document.createElement('li');
        li.className = task.completed ? 'completed' : '';
        
        const span = document.createElement('span');
        span.textContent = task.text;
        if (task.description) {
          span.innerHTML += `<small style="margin-left: 10px; color: #666;"> - ${task.description}</small>`;
        }
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = task.completed;
        checkbox.addEventListener('change', () => {
          toggleTaskCompletion(task.id, checkbox.checked);
        });
        
        li.appendChild(span);
        li.appendChild(checkbox);
        list.appendChild(li);
      });
    }

    // LocalStorage fallback functions
    const storageKey = { work: 'workTasks', personal: 'personalTasks' };

    function loadTasksFromLocalStorage() {
      ['work', 'personal'].forEach(type => {
        const saved = localStorage.getItem(storageKey[type]);
        const tasks = saved ? JSON.parse(saved) : [];
        renderTasksFromLocalStorage(type, tasks);
      });
    }

    function saveTaskToLocalStorage(text, type) {
      const tasks = JSON.parse(localStorage.getItem(storageKey[type])) || [];
      tasks.push({ 
        id: Date.now(), 
        text: text, 
        completed: false,
        type: type 
      });
      localStorage.setItem(storageKey[type], JSON.stringify(tasks));
      loadTasksFromLocalStorage();
    }

    function toggleTaskInLocalStorage(taskId, completed) {
      Object.values(storageKey).forEach(key => {
        const tasks = JSON.parse(localStorage.getItem(key)) || [];
        const task = tasks.find(t => t.id == taskId);
        if (task) {
          task.completed = completed;
          localStorage.setItem(key, JSON.stringify(tasks));
        }
      });
      loadTasksFromLocalStorage();
    }

    function renderTasksFromLocalStorage(type, tasks) {
      const list = document.getElementById(`${type}-list`);
      list.innerHTML = '';
      
      tasks.forEach((task, index) => {
        const li = document.createElement('li');
        li.className = task.completed ? 'completed' : '';
        
        const span = document.createElement('span');
        span.textContent = task.text;
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = task.completed;
        checkbox.addEventListener('change', () => {
          toggleTaskInLocalStorage(task.id, checkbox.checked);
        });
        
        li.appendChild(span);
        li.appendChild(checkbox);
        list.appendChild(li);
      });
    }

    // Shared functions
    function addTask(type) {
      const input = document.getElementById(`new-${type}-task`);
      const value = input.value.trim();
      if (!value) return;
      
      saveTask(value, type);
      input.value = '';
    }

    function updateConnectionStatus(mode) {
      const status = document.getElementById('connection-status');
      if (mode === 'database') {
        status.innerHTML = 'üü¢ Connected to database - tasks sync across devices';
        status.className = 'status-indicator database-connected';
      } else {
        status.innerHTML = 'üü° Using local storage - tasks saved locally only';
        status.className = 'status-indicator localStorage-fallback';
      }
    }

    // Chat functionality (unchanged)
    function submitPrompt() {
      const prompt = document.getElementById('gpt-prompt').value;
      if (!prompt.trim()) return;
      document.getElementById('gpt-response').innerText = 'Thinking...';
      fetch('https://calendar-backend-xwk6.onrender.com/ask-gpt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('gpt-response').innerText = data.answer || 'No response received.';
      })
      .catch(err => {
        console.error(err);
        document.getElementById('gpt-response').innerText = 'Error talking to GPT.';
      });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadTasks();
      
      // Add Enter key support for inputs
      document.getElementById('new-work-task').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addTask('work');
      });
      
      document.getElementById('new-personal-task').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addTask('personal');
      });
      
      document.getElementById('gpt-prompt').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          submitPrompt();
        }
      });
    });

    console.log('üì± Dashboard frontend updated to use database API with localStorage fallback!');
  </script>
</body>
</html>
